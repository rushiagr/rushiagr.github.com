<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="http://rushiagr.github.io/blog/2014/04/12/open-source-puppet-quick-start/index.html" />

    <title>  Sense, and Simplicity &mdash; Open Source Puppet - Quick Start
</title>



      <link type="application/rss+xml" rel="alternate" href="/feeds/all.rss.xml" title="Sense, and Simplicity RSS Feed">

    <link rel="stylesheet" href="http://rushiagr.github.io/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37074962-1', 'auto');
    ga('send', 'pageview');

  </script>

    <meta name="author" content="Rushi Agrawal">
  <meta name="tags" contents="tutorial, cheatsheet, puppet, tech, ubuntu, quicstart, ">
</head>

<body>
<header class="header">
  <div class="container">
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="http://rushiagr.github.io">Sense, and Simplicity</a>
      </h1>
      <h3 class="header-text">On interactions between softwares and humans. Rushi Agrawal's blog.</h3>
      <ul class="header-menu list-inline">
              <li class="muted">|</li>
            <li><a class="nodec" href="http://rushiagr.github.io/pages/about-me.html">About me</a></li>
              <li class="muted">|</li>
          <li><a class="nodec icon-github" href="https://github.com/rushiagr"></a></li>
          <li><a class="nodec icon-twitter" href="https://twitter.com/rushiagr"></a></li>
          <li><a class="nodec icon-rss" href="/feeds/all.rss.xml"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/blog/2014/04/12/open-source-puppet-quick-start/" title="Permalink to Open Source Puppet - Quick Start">Open Source Puppet - Quick Start</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/blog/2014/04/12/open-source-puppet-quick-start/" title="2014-04-12T00:00:00">Sat 12 April 2014</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="http://rushiagr.github.io/category/tech.html">tech</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
            <a href="/tag/tutorial.html">tutorial</a>,             <a href="/tag/cheatsheet.html">cheatsheet</a>,             <a href="/tag/puppet.html">puppet</a>,             <a href="/tag/tech.html">tech</a>,             <a href="/tag/ubuntu.html">ubuntu</a>,             <a href="/tag/quicstart.html">quicstart</a>        </li>
    </ul>
    <div class="post-content">
      <p>This post aims to be your quickest guide to get started with Puppet. We'll be using the open source version of Puppet. An hour of spare time and two Ubuntu machines (physical or virtual doesn't matter) is all that is needed.</p>
<!-- more -->

<h2>Quick Introduction</h2>
<p>Lets say you want to install and run apache server on one of the machines in your lab. On another, you want to create a new user. On a third machine, you want to install MySQL, and allow access to this machine only from the first server. Seems like a lot of manual work isn't it? The power of Puppet is, you can specify all these tasks in a file, called 'Puppet manifest', and then execute it. Everything will be set up for you just as you wanted! Now what makes this 'I care about the end result, not the process' approach really powerful is you can 'apply' this manifest over and over again to get the same end result. You can easily modify this manifest file, extend it, and manage it under version control, just like you would with a piece of software. Welcome to the world of IT automation :)</p>
<p>Although the syntax of a Puppet manifest is Ruby-ish, no knowledge of Ruby is required at all (I don't know Ruby).</p>
<p>There is a whole lot of things you can do with Puppet. Here, we'll just get us started with it. Once you are through this post, you can head over to Puppet Labs' documents and tutorials, for more on "how"s and "why"s of Puppet.</p>
<h2>Setup</h2>
<p>You just require two Ubuntu machines connected to each other. One will be the Puppet 'master' node (the machine which will take care of managing the configuration and state of all the machines in our deployment), the other one 'slave' (which unfortunately is the only actual machine in demo deployment :) ). </p>
<p>Here I am using two  virtual machines, but you can create one virtual machine and use your host machine as the other one. The hostnames of the master and slave in my setup are <code>puppet-master</code> and <code>puppet-agent</code>.</p>
<p>Make sure both the machines are ping-able from each other -- by their IP as well as hostnames (e.g. <code>ping 123.123.123.123</code> and <code>ping puppet-master</code>). Make sure your /etc/hosts file looks something like this to achieve that: </p>
<p>(<code>192.168.56.130</code> and <code>192.168.56.131</code> are the IP addresses of externally-visible interfaces of hosts <code>puppet-master</code> and <code>puppet-agent</code> respectively)</p>
<p>Master: </p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">127.0.0.1</span>   <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>   <span class="n">puppet</span><span class="o">-</span><span class="n">master</span>

<span class="mf">192.168.56.131</span>  <span class="n">puppet</span><span class="o">-</span><span class="n">agent</span>
</pre></div>


<p>Slave: </p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="o">:~</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">127.0.0.1</span>   <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>   <span class="n">puppet</span><span class="o">-</span><span class="n">agent</span>

<span class="mf">192.168.56.130</span>  <span class="n">puppet</span><span class="o">-</span><span class="n">master</span>
</pre></div>


<h2>Getting the hands dirty -- Puppet CLI</h2>
<p>Install <code>puppetmaster</code> package on the master node</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">puppetmaster</span>
</pre></div>


<p>List all the users on the current system:</p>
<div class="highlight"><pre><span class="n">puppet</span> <span class="n">resource</span> <span class="n">user</span> <span class="o">--</span><span class="n">list</span>
</pre></div>


<p>So basically a 'user' is a 'resource' in Puppet terminology. Now only list a specific resource. <code>r</code> is the current user in my case.</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">puppet</span> <span class="n">resource</span> <span class="n">user</span> <span class="n">r</span>
<span class="n">user</span> <span class="p">{</span> <span class="sc">&#39;r&#39;</span><span class="o">:</span>
  <span class="n">ensure</span>  <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="n">present</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">comment</span> <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="n">r</span><span class="p">,,,</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">gid</span>     <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="mi">1000</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">groups</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">adm</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">cdrom</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">sudo</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">dip</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">plugdev</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lpadmin</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">sambashare</span><span class="err">&#39;</span><span class="p">],</span>
  <span class="n">home</span>    <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">r</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">shell</span>   <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">uid</span>     <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="mi">1000</span><span class="err">&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>Notice the syntax. Resource 'r' is of type 'user', with 'ensure', 'comment', etc as keys/attributes, and 'present', 'r,,,' as values for those attributes.</p>
<p>You can change the value using the Puppet CLI</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">resource</span> <span class="n">user</span> <span class="n">r</span> <span class="n">comment</span><span class="o">=</span><span class="err">&#39;</span><span class="n">some</span> <span class="n">text</span> <span class="n">missing</span><span class="err">&#39;</span>
<span class="nl">notice:</span> <span class="o">/</span><span class="n">User</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">/</span><span class="n">comment</span><span class="o">:</span> <span class="n">comment</span> <span class="n">changed</span> <span class="err">&#39;</span><span class="n">r</span><span class="p">,,,</span><span class="err">&#39;</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">some</span> <span class="n">text</span> <span class="n">missing</span><span class="err">&#39;</span>
<span class="n">user</span> <span class="p">{</span> <span class="sc">&#39;r&#39;</span><span class="o">:</span>
  <span class="n">ensure</span>  <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="n">present</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">comment</span> <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="n">some</span> <span class="n">text</span> <span class="n">missing</span><span class="err">&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>Create a new user with specified key-value pairs</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">resource</span> <span class="n">user</span> <span class="n">katie</span> <span class="n">ensure</span><span class="o">=</span><span class="n">present</span> <span class="n">shell</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="nl">notice:</span> <span class="o">/</span><span class="n">User</span><span class="p">[</span><span class="n">katie</span><span class="p">]</span><span class="o">/</span><span class="n">ensure</span><span class="o">:</span> <span class="n">created</span>
<span class="n">user</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">katie</span><span class="err">&#39;</span><span class="o">:</span>
  <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="n">present</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">shell</span>  <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="err">&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">resource</span> <span class="n">user</span> <span class="n">katie</span> 
<span class="n">user</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">katie</span><span class="err">&#39;</span><span class="o">:</span>
  <span class="n">ensure</span>           <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="n">present</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">gid</span>              <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="mi">1001</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">home</span>             <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">katie</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">password</span>         <span class="o">=&gt;</span> <span class="sc">&#39;!&#39;</span><span class="p">,</span>
  <span class="n">password_max_age</span> <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="mi">99999</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">password_min_age</span> <span class="o">=&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
  <span class="n">shell</span>            <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="err">&#39;</span><span class="p">,</span>
  <span class="n">uid</span>              <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="mi">1001</span><span class="err">&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>Remove the newly created user, but this time, let's put this information into a file <code>katie_remove.pp</code> and ask Puppet to 'apply' this file and thus removing the user 'katie'.</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">cat</span> <span class="n">katie_remove</span><span class="p">.</span><span class="n">pp</span> 
<span class="n">user</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">katie</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="n">absent</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>Apply this Puppet manifest</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">apply</span> <span class="n">katie_absent</span><span class="p">.</span><span class="n">pp</span> 
<span class="nl">warning:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">retrieve</span> <span class="n">fact</span> <span class="n">fqdn</span>
<span class="nl">notice:</span> <span class="o">/</span><span class="n">Stage</span><span class="p">[</span><span class="n">main</span><span class="p">]</span><span class="c1">//User[katie]/ensure: removed</span>
<span class="nl">notice:</span> <span class="n">Finished</span> <span class="n">catalog</span> <span class="n">run</span> <span class="n">in</span> <span class="mf">0.47</span> <span class="n">seconds</span>
</pre></div>


<p>Puppet's description of user 'katie':</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">resource</span> <span class="n">user</span> <span class="n">katie</span>
  <span class="n">user</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">katie</span><span class="err">&#39;</span><span class="o">:</span>
  <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="n">absent</span><span class="err">&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>is now same as that of a non-existent user. </p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">resource</span> <span class="n">user</span> <span class="n">absent</span><span class="o">-</span><span class="n">user</span>
  <span class="n">user</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">absent</span><span class="o">-</span><span class="n">user</span><span class="err">&#39;</span><span class="o">:</span>
  <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="n">absent</span><span class="err">&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>That is, the user 'katie' is now deleted. You can see that the 'ensure' attribute can be used to make sure a user (or in general, any 'resource', is present, or absent).</p>
<p><strong>Note</strong>: Ignore the warning which is printed while applying a manifest from a file. Or if you are bothered by it popping up all the time, in the <code>/etc/hosts</code> file, change</p>
<div class="highlight"><pre><span class="mf">127.0.1.1</span>   <span class="n">puppet</span><span class="o">-</span><span class="n">master</span>
</pre></div>


<p>to</p>
<div class="highlight"><pre><span class="mf">127.0.1.1</span>   <span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">rushiagr</span><span class="p">.</span><span class="n">com</span> <span class="n">puppet</span><span class="o">-</span><span class="n">master</span>
</pre></div>


<p>where you can choose a domain name of your own choice in place of <code>.rushiagr.com</code>.</p>
<h2>Puppet modules</h2>
<p><strong>Note:</strong> <code>puppet module</code> doesn't work on Precise (Ubuntu 12.04). You need to install ruby, and gems, etc. Too much of a hassle. So I'll just post commands here which work for a higher version of Ubuntu.</p>
<p>Install standard library:</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">puppet</span> <span class="n">module</span> <span class="n">install</span> <span class="n">puppetlabs</span><span class="o">/</span><span class="n">stdlib</span>
</pre></div>


<p>View all the installed modules</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">module</span> <span class="n">list</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">modules</span>
<span class="err">├──</span> <span class="n">puppetlabs</span><span class="o">-</span><span class="n">mysql</span> <span class="p">(</span><span class="n">v2</span><span class="mf">.2.1</span><span class="p">)</span>
<span class="err">├──</span> <span class="n">puppetlabs</span><span class="o">-</span><span class="n">ntp</span> <span class="p">(</span><span class="n">v3</span><span class="mf">.0.2</span><span class="p">)</span>
<span class="err">└──</span> <span class="n">puppetlabs</span><span class="o">-</span><span class="n">stdlib</span> <span class="p">(</span><span class="n">v4</span><span class="mf">.1.0</span><span class="p">)</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">modules</span> <span class="p">(</span><span class="n">no</span> <span class="n">modules</span> <span class="n">installed</span><span class="p">)</span>
</pre></div>


<p>All the modules, and all other information in the system goes in <code>/etc/puppet</code> directory.</p>
<p><strong>Note</strong>: Modules installed via <code>sudo</code> will be visible when you perform <code>puppet module list</code> with <code>sudo</code> only. Same for non-<code>sudo</code> use.</p>
<h2>Puppet in master-client configuration</h2>
<p>Everything we did so far concerned with a single machine. Let's now introduce another machine -- Puppet agent.</p>
<p>Note that you need to set FQDNs for both the machines. See the step above, where we suppressed a warning.</p>
<p>First, we'll need to install <code>puppet</code> package (the agent) on the agent node.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">puppet</span>
</pre></div>


<p>By default, the Puppet agent service will not be running.</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">service</span> <span class="n">puppet</span> <span class="n">status</span>
 <span class="o">*</span> <span class="n">agent</span> <span class="n">is</span> <span class="n">not</span> <span class="n">running</span>
</pre></div>


<p>Before starting it, change <code>START=no</code> to <code>START=yes</code> in <code>/etc/default/puppet</code> file, to start the agent service by default when the system starts/reboots.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="n">s</span><span class="o">/</span><span class="n">START</span><span class="o">=</span><span class="n">no</span><span class="o">/</span><span class="n">START</span><span class="o">=</span><span class="n">yes</span><span class="o">/</span><span class="n">g</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">puppet</span>
</pre></div>


<p>And add these two lines at the end of <code>/etc/puppet/puppet.conf</code> to allow the agent to discover the master by its FQDN.</p>
<div class="highlight"><pre><span class="k">[agent]</span>
<span class="na">server</span> <span class="o">=</span> <span class="s">puppet-master</span>
</pre></div>


<p>Now start the Puppet agent service</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">service</span> <span class="n">puppet</span> <span class="n">start</span>
 <span class="o">*</span> <span class="n">Starting</span> <span class="n">puppet</span> <span class="n">agent</span>                                   <span class="p">[</span> <span class="n">OK</span> <span class="p">]</span>
</pre></div>


<p>I also make sure that clocks of both the machines are synchronized by running <code>ntpdate</code> on both master and slave. I am not sure if this is required, but doesn't do any harm.
    sudo ntpdate pool.ntp.org</p>
<p>Now the master needs to sign the certs by agent.</p>
<p>Execute this command on agent node.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">puppet</span> <span class="n">agent</span> <span class="o">--</span><span class="n">test</span> <span class="o">--</span><span class="n">waitforcert</span> <span class="mi">60</span>
</pre></div>


<p>Now hop over to the master node, and retrieve the list of certs waiting to be signed</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">cert</span> <span class="o">--</span><span class="n">list</span>
  <span class="s">&quot;puppet-agent.rushiagr.com&quot;</span> <span class="p">(</span><span class="n">EB</span><span class="o">:</span><span class="mf">0F</span><span class="o">:</span><span class="n">E4</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mf">6F</span><span class="o">:</span><span class="n">B2</span><span class="o">:</span><span class="mi">7</span><span class="n">E</span><span class="o">:</span><span class="mi">85</span><span class="o">:</span><span class="mi">7</span><span class="n">E</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="n">C4</span><span class="o">:</span><span class="mi">78</span><span class="o">:</span><span class="mi">80</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="n">E1</span><span class="p">)</span>
</pre></div>


<p>Sign the cert</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">master</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">cert</span> <span class="n">sign</span> <span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="p">.</span><span class="n">rushiagr</span><span class="p">.</span><span class="n">com</span>
<span class="nl">notice:</span> <span class="n">Signed</span> <span class="n">certificate</span> <span class="n">request</span> <span class="k">for</span> <span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="p">.</span><span class="n">rushiagr</span><span class="p">.</span><span class="n">com</span>
<span class="nl">notice:</span> <span class="n">Removing</span> <span class="n">file</span> <span class="n">Puppet</span><span class="o">::</span><span class="n">SSL</span><span class="o">::</span><span class="n">CertificateRequest</span> <span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="p">.</span><span class="n">rushiagr</span><span class="p">.</span><span class="n">com</span> <span class="n">at</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">requests</span><span class="o">/</span><span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="p">.</span><span class="n">rushiagr</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">pem</span><span class="err">&#39;</span>
</pre></div>


<p>Now we are ready to go. Let's create a file ('Puppet manifest') on master where we write that: 1. We want apache package to be installed. 2. Once we ensure that the package is installed, we want to start the apache service. We'll name the file <code>site.pp</code>, which is the 'main' configuration file for Puppet. We'll put it into <code>/etc/puppet/manifests</code> directory. Note how we can specify a dependency between resources.</p>
<div class="highlight"><pre><span class="n">package</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">apache2</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="n">installed</span>
<span class="p">}</span>

<span class="n">service</span> <span class="p">{</span> <span class="err">&#39;</span><span class="n">apache2</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="nb">true</span><span class="p">,</span>
    <span class="n">enable</span> <span class="o">=&gt;</span> <span class="nb">true</span><span class="p">,</span>
    <span class="n">require</span> <span class="o">=&gt;</span> <span class="n">Package</span><span class="p">[</span><span class="err">&#39;</span><span class="n">apache2</span><span class="err">&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>Puppet works on 'push' model, meaning configurations are pulled by agents at periodic intervals. I think the default periodic interval is 30 minutes. Alternatively, you can pull from agent at your own will, any time. Let's do that now. Execute this command on the agent:</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">puppet</span> <span class="n">agent</span> <span class="o">--</span><span class="n">test</span>
<span class="nl">info:</span> <span class="n">Caching</span> <span class="n">catalog</span> <span class="k">for</span> <span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="p">.</span><span class="n">rushiagr</span><span class="p">.</span><span class="n">com</span>
<span class="nl">info:</span> <span class="n">Applying</span> <span class="n">configuration</span> <span class="n">version</span> <span class="err">&#39;</span><span class="mi">1397343482</span><span class="err">&#39;</span>
<span class="nl">notice:</span> <span class="o">/</span><span class="n">Stage</span><span class="p">[</span><span class="n">main</span><span class="p">]</span><span class="c1">//Package[apache2]/ensure: ensure changed &#39;purged&#39; to &#39;present&#39;</span>
<span class="nl">notice:</span> <span class="n">Finished</span> <span class="n">catalog</span> <span class="n">run</span> <span class="n">in</span> <span class="mf">6.30</span> <span class="n">seconds</span>
</pre></div>


<p>And you can see the apache server running!</p>
<div class="highlight"><pre><span class="n">r</span><span class="err">@</span><span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">service</span> <span class="n">apache2</span> <span class="n">status</span>
<span class="n">Apache2</span> <span class="n">is</span> <span class="n">running</span> <span class="p">(</span><span class="n">pid</span> <span class="mi">5874</span><span class="p">).</span>
</pre></div>


<p>Ta! Da!</p>
<p>Please comment if you have any ideas to make this post easier for the newbies to understand.</p>
<p>Cheers!</p>
<p><strong>Notes:</strong></p>
<p>This is just a quick start guide. There are excellent resources and docs at <a href="http://puppetlabs.com">puppetlabs.com</a>. I have their beginner's <a href="https://dl.dropboxusercontent.com/u/42084476/OpenStack/learningpuppet.pdf">PDF</a> saved in my DropBox. 
Around 80 pages long, it covers almost every aspect of basic Puppet. The only problem with this guide is it is (I think deliberately) made to work only with the Enterprise Puppet version, but you can always refer back to this post to know how to set the open source version :)</p>
<p>If you mess up the cert signing process, here is a quick and dirty way to get it resolved. On master:</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">puppet</span> <span class="n">cert</span> <span class="n">clean</span> <span class="n">puppet</span><span class="o">-</span><span class="n">agent</span><span class="p">.</span><span class="n">rushiagr</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<p>On both master and slave:
    sudo rm -r /var/lib/puppet/ssl 
    sudo service puppet restart</p>
    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  <div id="disqus_thread">
    <script>
      var disqus_shortname = 'rushiagr';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript=rushiagr">
        comments powered by Disqus.
      </a>
    </noscript>
    <a href="https://disqus.com" class="dsq-brlink">
      blog comments powered by <span class="logo-disqus">Disqus</span>
    </a>
  </div>
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      Rushi Agrawal, <a href="" target="_blank"></a> unless otherwise noted.
    </p>
    <div class="text-center">
      Generated by <a href="http://getpelican.com" target="_blank">Pelican</a> with the <a href="http://github.com/nairobilug/pelican-alchemy">alchemy</a> theme.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="http://rushiagr.github.io/theme/js/jquery.min.js"></script>
  <script src="http://rushiagr.github.io/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>