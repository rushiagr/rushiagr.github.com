<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="http://rushiagr.github.io/blog/2014/01/12/installing-openid-plugin-for-mediawiki/index.html" />

    <title>  Sense, and Simplicity &mdash; Installing OpenID plugin for MediaWiki
</title>



      <link type="application/rss+xml" rel="alternate" href="/feeds/all.rss.xml" title="Sense, and Simplicity RSS Feed">

    <link rel="stylesheet" href="http://rushiagr.github.io/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37074962-1', 'auto');
    ga('send', 'pageview');

  </script>

    <meta name="author" content="Rushi Agrawal">
  <meta name="tags" contents="tech, ubuntu, openid, tutorial, cheatsheet, ">
</head>

<body>
<header class="header">
  <div class="container">
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="http://rushiagr.github.io">Sense, and Simplicity</a>
      </h1>
      <h3 class="header-text">On interactions between softwares and humans. Rushi Agrawal's blog.</h3>
      <ul class="header-menu list-inline">
              <li class="muted">|</li>
            <li><a class="nodec" href="http://rushiagr.github.io/pages/about-me.html">About me</a></li>
              <li class="muted">|</li>
          <li><a class="nodec icon-github" href="https://github.com/rushiagr"></a></li>
          <li><a class="nodec icon-twitter" href="https://twitter.com/rushiagr"></a></li>
          <li><a class="nodec icon-rss" href="/feeds/all.rss.xml"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/blog/2014/01/12/installing-openid-plugin-for-mediawiki/" title="Permalink to Installing OpenID plugin for MediaWiki">Installing OpenID plugin for MediaWiki</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/blog/2014/01/12/installing-openid-plugin-for-mediawiki/" title="2014-01-12T00:00:00">Sun 12 January 2014</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="http://rushiagr.github.io/category/tech.html">tech</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
            <a href="/tag/tech.html">tech</a>,             <a href="/tag/ubuntu.html">ubuntu</a>,             <a href="/tag/openid.html">openid</a>,             <a href="/tag/tutorial.html">tutorial</a>,             <a href="/tag/cheatsheet.html">cheatsheet</a>        </li>
    </ul>
    <div class="post-content">
      <p>This post is about setting up your wiki such that their users access the wiki
only via an OpenID provider login (e.g. Google or Facebook login). This post assumes 
MediaWiki is already installed.</p>
<!--more-->

<h3>Assumptions, prerequisites and requirements</h3>
<p>All of what this blogpost says has been tried on an Ubuntu machine, but it 
should work well on other Linux distros too (except for the <code>apt-get</code> package 
installs, for which you'll need to find alternatives on your favourite distro).</p>
<p><code>$IP</code> is assumed to be the root of your wiki directory (which in my case is
<code>/var/www/wikis/&lt;my_wiki&gt;/</code>.</p>
<p>Install all the required packages for the plugin to work</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">php5</span><span class="o">-</span><span class="n">mcrypt</span> <span class="n">php5</span><span class="o">-</span><span class="n">gmp</span>
</pre></div>


<h2>Installing the plugin</h2>
<p>Get the source code for the extension into <code>$IP/extensions</code> directory</p>
<div class="highlight"><pre>    <span class="n">cd</span> <span class="n">extensions</span>
    <span class="n">git</span> <span class="n">clone</span> <span class="n">http</span><span class="o">:</span><span class="c1">//gerrit.wikimedia.org/r/p/mediawiki/extensions/OpenID.git </span>
</pre></div>


<p>Check your mediawiki version by going to <code>&lt;your_wiki_URL&gt;/index.php?title=Special:Version</code>. Say your version is 1.19.x. 
  Check out branch for the same version of OpenID code</p>
<div class="highlight"><pre>    <span class="n">git</span> <span class="n">branch</span> <span class="o">-</span><span class="n">a</span> 
    <span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">stable_REL1_19</span> <span class="n">origin</span><span class="o">/</span><span class="n">REL1_19</span> 
</pre></div>


<p>Add this line at the end of LocalSettings.php file</p>
<div class="highlight"><pre><span class="n">require_once</span> <span class="s">&quot;$IP/extensions/OpenID/OpenID.php&quot;</span><span class="p">;</span> 
</pre></div>


<p>Now install Auth subdirectory as following:</p>
<div class="highlight"><pre>    <span class="n">cd</span> <span class="err">$</span><span class="n">IP</span><span class="o">/</span><span class="n">extensions</span><span class="o">/</span><span class="n">OpenID</span> 
    <span class="n">git</span> <span class="n">clone</span> <span class="n">http</span><span class="o">:</span><span class="c1">//github.com/openid/php-openid.git </span>
    <span class="n">mv</span> <span class="n">php</span><span class="o">-</span><span class="n">openid</span><span class="o">/</span><span class="n">Auth</span> <span class="n">Auth</span> 
    <span class="n">rm</span> <span class="o">-</span><span class="n">r</span> <span class="n">php</span><span class="o">-</span><span class="n">openid</span> 
    <span class="n">cd</span> <span class="err">$</span><span class="n">IP</span> 
    <span class="n">php</span> <span class="n">maintenance</span><span class="o">/</span><span class="n">update</span><span class="p">.</span><span class="n">php</span> <span class="o">--</span><span class="n">conf</span> <span class="n">LocalSettings</span><span class="p">.</span><span class="n">php</span> 
</pre></div>


<p>Restart apache server</p>
<div class="highlight"><pre>    <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">apache2</span> <span class="n">restart</span> 
</pre></div>


<h3>Editing 'Login required' page.</h3>
<p>By default, the main page of the wiki is not editable. Generally we would like
to give some information to a user, e.g. what this wiki is all about, how
to log into it, which OpenIDs are permitted, etc.</p>
<p>Now we'll give any registered user the ability to edit the protected pages and the 
'interface' pages, of which our special login page is a part of. Add these lines
 to <code>$IP/LocalSettings.php</code>:</p>
<div class="highlight"><pre>    <span class="err">$</span><span class="n">wgGroupPermissions</span><span class="p">[</span><span class="err">&#39;</span><span class="n">user</span><span class="err">&#39;</span><span class="p">][</span><span class="err">&#39;</span><span class="n">editprotected</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> 
    <span class="err">$</span><span class="n">wgGroupPermissions</span><span class="p">[</span><span class="err">&#39;</span><span class="n">user</span><span class="err">&#39;</span><span class="p">][</span><span class="err">&#39;</span><span class="n">editinterface</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> 
</pre></div>


<p>Now you can edit the <code>&lt;your_wiki_URL&gt;/jiocloud/index.phpmediawiki:loginreqpagetext</code>
 page which is presented when the user is not logged in.</p>
<h3>Other settings</h3>
<p>Below you can see a snip of LocalSettings.php file, which contains many other 
fields which I used to customize my wiki. I allowed only the registered user 
an edit permission (which most of you would also want I guess). Also, I have disabled
regular login, and made it mandatory users to login via only OpenID, and that too, 
only using their launchpad.net accounts (an issue tracking software from Canonical).</p>
<p>If you want to get more information regarding these (and more) 
configuration options, see <a href="http://www.mediawiki.org/wiki/Extension:OpenID" target="_blank">this</a> link.</p>
<div class="highlight"><pre><span class="cp"># Disable reading by anonymous users</span>
<span class="err">$</span><span class="n">wgGroupPermissions</span><span class="p">[</span><span class="sc">&#39;*&#39;</span><span class="p">][</span><span class="err">&#39;</span><span class="n">read</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="cp"># Disable anonymous editing too</span>
<span class="err">$</span><span class="n">wgGroupPermissions</span><span class="p">[</span><span class="sc">&#39;*&#39;</span><span class="p">][</span><span class="err">&#39;</span><span class="n">edit</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="cp"># But allow them to access the OpenID login page or else there will be no way to log in!</span>
<span class="err">$</span><span class="n">wgWhitelistRead</span> <span class="o">=</span> <span class="n">array</span> <span class="p">(</span><span class="s">&quot;Special:OpenIDLogin&quot;</span><span class="p">,</span> <span class="s">&quot;Special:OpenIDFinish&quot;</span><span class="p">,</span> 
<span class="s">&quot;MediaWiki:Common.css&quot;</span><span class="p">,</span> <span class="s">&quot;MediaWiki:Common.js&quot;</span><span class="p">,</span> <span class="s">&quot;MediaWiki:Monobook.css&quot;</span><span class="p">,</span> 
<span class="s">&quot;MediaWiki:Monobook.js&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">);</span>

<span class="cp"># For registered users, allow editing protected pages</span>
<span class="err">$</span><span class="n">wgGroupPermissions</span><span class="p">[</span><span class="err">&#39;</span><span class="n">user</span><span class="err">&#39;</span><span class="p">][</span><span class="err">&#39;</span><span class="n">editprotected</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="err">$</span><span class="n">wgGroupPermissions</span><span class="p">[</span><span class="err">&#39;</span><span class="n">user</span><span class="err">&#39;</span><span class="p">][</span><span class="err">&#39;</span><span class="n">editinterface</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="cp"># Only allow OpenIDs for login</span>
<span class="err">$</span><span class="n">wgOpenIDLoginOnly</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="err">$</span><span class="n">wgOpenIDOnly</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>       <span class="err">#</span> <span class="n">a</span> <span class="n">value</span> <span class="n">used</span> <span class="n">with</span> <span class="n">older</span> <span class="n">versions</span><span class="p">.</span> <span class="n">Optional</span>

<span class="cp"># Your wiki web URL</span>
<span class="err">$</span><span class="n">wgOpenIDTrustRoot</span> <span class="o">=</span> <span class="s">&quot;http://your.wiki.url.com/&quot;</span><span class="p">;</span>

<span class="cp"># By default, deny all OpenID</span>
<span class="err">$</span><span class="n">wgOpenIDConsumerDenyByDefault</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="cp"># Then allow only launchpad.net OpenID (with and without HTTPS both)</span>
<span class="err">$</span><span class="n">wgOpenIDConsumerAllow</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&quot;@^(https://)?launchpad.net/@&quot;</span><span class="p">);</span>
</pre></div>


<h2>Troubleshooting</h2>
<p>If there are troubles uploading a file via the MediaWiki web interface, go to the wiki directory on the server and chown the <code>images</code> folder.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="o">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">images</span><span class="o">/</span>
</pre></div>


<p>Don't forget to comment if you find the information presented here is outdated, or is not working for you.</p>
<p>Cheers,
Rushi</p>
    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  <div id="disqus_thread">
    <script>
      var disqus_shortname = 'rushiagr';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] ||
         document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript=rushiagr">
        comments powered by Disqus.
      </a>
    </noscript>
    <a href="https://disqus.com" class="dsq-brlink">
      blog comments powered by <span class="logo-disqus">Disqus</span>
    </a>
  </div>
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      Rushi Agrawal, <a href="" target="_blank"></a> unless otherwise noted.
    </p>
    <div class="text-center">
      Generated by <a href="http://getpelican.com" target="_blank">Pelican</a> with the <a href="http://github.com/nairobilug/pelican-alchemy">alchemy</a> theme.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="http://rushiagr.github.io/theme/js/jquery.min.js"></script>
  <script src="http://rushiagr.github.io/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>